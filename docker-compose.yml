version: '3.8'

services:
  # 1. IPFS Node
  ipfs:
    image: ipfs/go-ipfs:latest
    container_name: zkbar-ipfs
    ports:
      - "4001:4001"   # Swarm
      - "5001:5001"   # API
      - "8080:8080"   # Gateway
    volumes:
      - ipfs_data:/data/ipfs
    environment:
      - IPFS_PROFILE=server

  # 2. Hardhat Network (Local EVM)
  hardhat:
    image: node:22-alpine
    container_name: zkbar-hardhat
    working_dir: /usr/src/app
    volumes:
      - ./smart-contracts-eth:/usr/src/app
    command: /bin/sh -c "npm install && npx hardhat node"
    ports:
      - "8545:8545"

  # 3. Backend API
  backend-api:
    image: node:22-alpine
    container_name: zkbar-backend
    working_dir: /usr/src/app
    volumes:
      - ./backend-api:/usr/src/app
    command: /bin/sh -c "npm install && npm run start"
    ports:
      - "3000:3000"
    env_file:
      - ./backend-api/.env
    environment:
      - RPC_URL=http://hardhat:8545
    depends_on:
      - hardhat
      - ipfs

  # 4. Frontend Application
  frontend-app:
    image: node:22-alpine
    container_name: zkbar-frontend
    working_dir: /usr/src/app
    volumes:
      - ./frontend-app:/usr/src/app
    command: /bin/sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    depends_on:
      - backend-api

volumes:
  ipfs_data:
